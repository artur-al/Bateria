<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bateria Digital | Dashboard</title>

    <link rel="stylesheet" href="../assets/style/dashboards.css">
    <link rel="stylesheet" href="../assets/style/style.css" />
    <script src="../assets/app/sessão.js"></script>
    <script src="../assets/app/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body onload="validarSessao(), carregarDashboard()">
    <div class="janela">
        <div class="header-left">
            <h1>Bateria Digital</h1>
            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>
            <div class="btn-nav-white">
                <a href="./cards.html">
                    <h3>Minhas Levadas</h3>
                </a>
            </div>
            <div class="btn-nav">
                <h3>Painel das Escolas</h3>
            </div>
            <div class="btn-nav-white">
                <select id="selectAgremiacao" onchange="filtrarDashboard()">
                    <option value="todas">Todas Agremiações</option>
                    <option value="1">Gaviões da Fiel</option>
                    <option value="2">Pérola Negra</option>
                    <option value="3">Vai-Vai</option>
                    <option value="4">União da Ilha</option>
                </select>
            </div>
            <div class="btn-logout" onclick="limparSessao()">
                <h3><a href="./profile.html">Sair</a></h3>
            </div>
        </div>

        <div class="dash">
            <div id="alerta"></div>
            <div class="kpi-container" id="kpiContainer"></div>

            <div class="filtros-container">
                <div class="filtro-item">
                    <label for="filtroAno">Ano:</label>
                    <select id="filtroAno" onchange="filtrarDashboard()">
                        <option value="todos">Todos</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtroProgresso">Progresso:</label>
                    <select id="filtroProgresso" onchange="filtrarDashboard()">
                        <option value="todos">Todos</option>
                        <option value="0-30">0-30%</option>
                        <option value="30-70">30-70%</option>
                        <option value="70-100">70-100%</option>
                    </select>
                </div>
            </div>

            <div class="cards" id="cardsLevadas"></div>

            <div class="graficos-container">
                <h3 class="tituloGraficos">Desempenho das Levadas</h3>
                <div class="graph">
                    <canvas id="graficoDesempenho"></canvas>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    function carregarDashboard() {
        validarSessao();
        const idUsuario = sessionStorage.ID_USUARIO;
        const filtroAgremiacao = document.getElementById('selectAgremiacao').value;

        if (idUsuario) {
            carregarKPIs(idUsuario, filtroAgremiacao);

            if (filtroAgremiacao === "todas") {
                carregarLevadasUsuario(idUsuario);
            } else {
                carregarLevadasAgremiacao(filtroAgremiacao);
            }
        }
    }

    const url_api = 'http://localhost:3333';

    function carregarKPIs(idUsuario, idAgremiacao) {
        let url = `${url_api}/levada/kpis?idUsuario=${idUsuario}`;

        if (idAgremiacao && idAgremiacao !== 'todas') {
            url += `&idAgremiacao=${idAgremiacao}`;
        }

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    atualizarKPI(data.data);
                } else {
                    throw new Error(data.error || 'Erro nos dados dos KPIs');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar KPIs:', error);
                atualizarKPI({
                    totalLevadas: 12,
                    levadasPublicas: 8,
                    bpmMedio: 118,
                    topAgremiacao: 'Gaviões da Fiel',
                    instrumentoMaisUsado: 'Surdo',
                    usuariosAtivos: 3
                });
            });
    }

    function carregarLevadasUsuario(idUsuario) {
        fetch(`${url_api}/levada/usuario/${idUsuario}`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(levadas => {
                const levadasFormatadas = processarLevadas(levadas);
                exibirCardsLevadas(levadasFormatadas);
                carregarGraficoDesempenho(levadasFormatadas);
            })
            .catch(error => {
                console.error('Erro ao carregar levadas:', error);
                exibirMensagemErro('Não foi possível carregar as levadas');
            });
    }

    function calcularBPMMedio(levadas) {
        if (!Array.isArray(levadas)) return 0;

        const levadasComBPM = levadas.filter(levada => levada.bpm && !isNaN(levada.bpm));
        if (levadasComBPM.length === 0) return 0;

        const somaBPM = levadasComBPM.reduce((total, levada) => total + parseInt(levada.bpm), 0);
        return Math.round(somaBPM / levadasComBPM.length);
    }

    function atualizarKPI(dados) {
        const bpmMedio = calcularBPMMedio(levadas);
        document.getElementById('kpiContainer').innerHTML = `
        <div class="kpi-card">
            <i class="fas fa-music"></i>
            <div class="kpi-value">${dados.totalLevadas || 0}</div>
            <div class="kpi-label">Total Levadas</div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-chart-line"></i>
            <div class="kpi-value">${bpmMedio || 0}</div>
            <div class="kpi-label">BPM Médio</div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-users"></i>
            <div class="kpi-value">${dados.usuariosAtivos || 0}</div>
            <div class="kpi-label">Usuários Ativos</div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-drum"></i>
            <div class="kpi-value">${dados.instrumentoMaisUsado || '-'}</div>
            <div class="kpi-label">Instrumentos</div>
        </div>
    `;
    }

    function carregarLevadas(idUsuario, idAgremiacao) {
        const endpoint = idAgremiacao === 'todas'
            ? `${url_api}/levada/usuario/${idUsuario}`
            : `${url_api}/levada/agremiacao/${idAgremiacao}`;

        fetch(endpoint)
            .then(response => {
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                return response.json();
            })
            .then(levadas => {
                if (!Array.isArray(levadas)) throw new Error('Dados inválidos recebidos');

                const levadasFormatadas = processarLevadas(levadas);
                exibirCardsLevadas(levadasFormatadas);

                if (levadasFormatadas.length > 0) {
                    carregarGraficoDesempenho(levadasFormatadas);
                } else {
                    if (window.graficoDesempenho && typeof window.graficoDesempenho.destroy === 'function') {
                        window.graficoDesempenho.destroy();
                        window.graficoDesempenho = null;
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao carregar levadas:', error);
                exibirMensagemErro('Erro ao carregar levadas. Tente novamente.');
            });
    }

    function processarLevadas(levadas) {
        return levadas.map(levada => ({
            ...levada,
            padrao: Array.isArray(levada.padrao) ? levada.padrao : [],
            bpm: levada.bpm || 0,
            instrumento: levada.instrumento || 'Vários',
            progresso: calcularProgresso(levada.padrao)
        }));
    }

    function calcularProgresso(padrao) {
        if (!Array.isArray(padrao)) return 0;
        const completas = padrao.filter(nota => nota.completa).length;
        return padrao.length > 0 ? Math.round((completas / padrao.length) * 100) : 0;
    }

    function exibirCardsLevadas(levadas) {
        const container = document.getElementById('cardsLevadas');
        container.innerHTML = '';

        if (levadas.length === 0) {
            container.innerHTML = `
            <div class="card-levada">
                <p>Nenhuma levada encontrada</p>
            </div>
        `;
            return;
        }

        levadas.forEach(levada => {
            container.innerHTML += `
            <div class="card-levada" data-id="${levada.id}">
                <div class="header-levada">
                    <h2>${levada.nome}</h2>
                    <span class="status ${getStatusClass(levada.progresso)}">
                        ${levada.progresso}% • ${levada.instrumento} • ${levada.bpm}BPM
                    </span>
                </div>
                <div class="detalhes-levada">
                    <div class="info">
                        <p><strong>Agremiação:</strong> ${levada.agremiacao || 'Não especificado'}</p>
                        <p><strong>Criada em:</strong> ${formatarData(levada.dataCriacao)}</p>
                        <p><strong>Notas:</strong> ${levada.padrao.length} (${levada.padrao.filter(n => n.completa).length} completas)</p>
                    </div>
                    <div class="progresso">
                        <div class="progresso-bar" style="width: ${levada.progresso}%"></div>
                    </div>
                </div>
                <div class="acoes-levada">
                    <button class="btn-acao" onclick="detalharLevada(${levada.id})">
                        <i class="fas fa-info-circle"></i> 
                    </button>
                    <button class="btn-acao" onclick="editarLevada(${levada.id})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            </div>
        `;
        });
    }

    function carregarGraficoDesempenho(levadas) {
        try {
            const dados = processarDadosParaGrafico(levadas);
            plotarGraficoDesempenho(dados);
        } catch (error) {
            console.error('Erro ao processar dados para gráfico:', error);
            exibirMensagemErro('Erro ao gerar gráfico de desempenho');
        }
    }

    function processarDadosParaGrafico(levadas) {
        if (!Array.isArray(levadas) || levadas.length === 0) {
            return {
                labels: ['Sem dados'],
                datasets: [
                    {
                        label: 'BPM Médio',
                        data: [0],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Progresso Médio (%)',
                        data: [0],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }
                ]
            };
        }

        const agrupamento = levadas.reduce((acc, levada) => {
            const key = levada.agremiacao || 'Outras';
            if (!acc[key]) {
                acc[key] = { total: 0, somaBPM: 0, somaProgresso: 0 };
            }
            acc[key].total++;
            acc[key].somaBPM += levada.bpm || 0;
            acc[key].somaProgresso += levada.progresso || 0;
            return acc;
        }, {});

        const labels = Object.keys(agrupamento);
        const dadosBPM = labels.map(k => Math.round(agrupamento[k].somaBPM / agrupamento[k].total));
        const dadosProgresso = labels.map(k => Math.round(agrupamento[k].somaProgresso / agrupamento[k].total));

        return {
            labels: labels,
            datasets: [
                {
                    label: 'BPM Médio',
                    data: dadosBPM,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Progresso Médio (%)',
                    data: dadosProgresso,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }
            ]
        };
    }

    function plotarGraficoDesempenho(dados) {
        const ctx = document.getElementById('graficoDesempenho');

        if (window.graficoDesempenho && typeof window.graficoDesempenho.destroy === 'function') {
            window.graficoDesempenho.destroy();
        }

        window.graficoDesempenho = new Chart(ctx, {
            type: 'bar',
            data: dados,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: Math.max(...dados.datasets.flatMap(d => d.data)) + 20,
                        title: {
                            display: true,
                            text: 'Valores'
                        }
                    }
                }
            }
        });
    }

    function getStatusClass(progresso) {
        if (progresso >= 80) return 'ideal';
        if (progresso >= 50) return 'alerta';
        return 'perigo';
    }

    function formatarData(dataString) {
        if (!dataString) return 'Não definido';
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return new Date(dataString).toLocaleDateString('pt-BR', options);
    }

    function filtrarDashboard() {
        carregarDashboard();
    }

    let iniciarLevada = {
        currentLevadaId: null,
        currentStep: 0,
        timer: null,
        iniciarTimer: null,
        audioContext: null,
        sons: {}
    }
    function tocarLevada(id) {
        if (iniciarLevada.currentLevadaId === id) {
            pararLevada();
            return;
        }

        if (iniciarLevada.currentLevadaId) {
            pararLevada();
        }

        fetch(`${url_api}/levada/${id}`)
            .then(response => response.json())
            .then(levada => {
                const padrao = Array.isArray(levada.padrao) ? levada.padrao : [];
                if (padrao.length === 0) return;

                iniciarLevada = {
                    currentLevadaId: id,
                    currentStep: 0,
                    timer: null,
                    iniciarTimer: Date.now(),
                    audioContext: new (window.AudioContext || window.webkitAudioContext)(),
                    sons: {}
                };

                padrao.forEach((nota, index) => {
                    iniciarLevada.sons[index] = {
                        nome: nota.nome,
                        tempo: nota.tempo,
                        arquivo: nota.arquivo || 'default.mp3' //colocar o caminho da levada puxando do banco ainda
                    };
                });

                iniciarReproducao(padrao, id);
            })
            .catch(error => {
                console.error('Erro ao carregar levada:', error);
                exibirMensagemErro('Erro ao carregar levada para reprodução');
            });
    }

    function iniciarReproducao(padrao, id) {
        const card = document.querySelector(`.card-levada[data-id="${id}"]`);
        const progressBar = card.querySelector(`#progressBar-${id}`);
        const timeDisplay = card.querySelector(`#timeDisplay-${id}`);

        const playButton = card.querySelector('.btn-play');
        playButton.innerHTML = '<i class="fas fa-pause"></i>';

        const duracaoTotal = padrao[padrao.length - 1].tempo - padrao[0].tempo;

        const atualizarProgresso = () => {
            const tempoDecorrido = Date.now() - iniciarLevada.iniciarTimer;
            const progresso = Math.min(100, (tempoDecorrido / duracaoTotal) * 100);

            progressBar.style.width = `${progresso}%`;

            const segundos = Math.floor(tempoDecorrido / 1000);
            timeDisplay.textContent = `${Math.floor(segundos / 60)}:${(segundos % 60).toString().padStart(2, '0')}`;

            padrao.forEach((nota, index) => {
                if (nota.tempo <= tempoDecorrido && !iniciarLevada.sons[index].tocada) {
                    tocarNota(nota);
                    iniciarLevada.sons[index].tocada = true;

                    const progressoCard = Math.round(((index + 1) / padrao.length) * 100);
                    card.querySelector('.progresso-bar').style.width = `${progressoCard}%`;
                    card.querySelector('.status').textContent = `${progressoCard}% • ${levada.instrumento} • ${levada.bpm}BPM`;
                }
            });

            if (tempoDecorrido < duracaoTotal) {
                iniciarLevada.timer = requestAnimationFrame(atualizarProgresso);
            } else {
                pararLevada();
                progressBar.style.width = '100%';
                timeDisplay.textContent = 'Concluído';
                playButton.innerHTML = '<i class="fas fa-redo"></i>';
            }
        };

        iniciarLevada.timer = requestAnimationFrame(atualizarProgresso);
    }

    function tocarNota(nota) {
        console.log(`Tocando: ${nota.nome} em ${nota.tempo}ms`);
        if (nota.arquivo) {
            const audio = new Audio(`/sons/${nota.arquivo}`);
            audio.play().catch(e => console.error("Erro ao reproduzir áudio:", e));
        }
    }

    function pararLevada() {
        if (iniciarLevada.timer) {
            cancelAnimationFrame(iniciarLevada.timer);
        }
        if (iniciarLevada.audioContext) {
            iniciarLevada.audioContext.close();
        }

        if (iniciarLevada.currentLevadaId) {
            const card = document.querySelector(`.card-levada[data-id="${iniciarLevada.currentLevadaId}"]`);
            if (card) {
                const playButton = card.querySelector('.btn-play');
                if (playButton) playButton.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        iniciarLevada = {
            currentLevadaId: null,
            currentStep: 0,
            timer: null,
            iniciarTimer: null,
            audioContext: null,
            sons: {}
        };
    }

    function detalharLevada(id) {
        const card = document.querySelector(`.card-levada[data-id="${id}"]`);

        if (card.querySelector('.audio-player')) {
            return;
        }
        fetch(`${url_api}/levada/${id}`)
            .then(response => response.json())
            .then(levada => {
                const padrao = Array.isArray(levada.padrao) ? levada.padrao : [];

                const playerHTML = `
                <div class="audio-player">
                    <div class="player-controls">
                        <button class="btn-play" onclick="tocarLevada(${id})">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="progress-container">
                            <div class="progress-bar" id="progressBar-${id}"></div>
                        </div>
                        <span class="time-display" id="timeDisplay-${id}">0:00</span>
                    </div>
                </div>
            `;

                const acoesDiv = card.querySelector('.acoes-levada');
                acoesDiv.insertAdjacentHTML('beforeend', playerHTML);

                tocarLevada(id);
            })
            .catch(error => {
                console.error('Erro ao carregar levada:', error);
                exibirMensagemErro('Erro ao carregar levada para reprodução');
            });
    }

    function editarLevada(id) {
        window.location.href = `editar.html?id=${id}`;
    }

    function validarSessao() {
        const email = sessionStorage.EMAIL_USUARIO;
        const nome = sessionStorage.NOME_USUARIO;
        const b_usuario = document.getElementById("b_usuario");

        if (email && nome) {
            b_usuario.innerHTML = nome;
        } else {
            window.location.href = "/login.html";
        }
    }
    function exibirMensagemErro(mensagem) {
        const alertaDiv = document.getElementById('alerta');
        if (!alertaDiv) return;

        alertaDiv.innerHTML = `
        <div class="alert alert-error">
            <i class="fas fa-exclamation-triangle"></i>
            <span>${mensagem}</span>
        </div>
    `;
        setTimeout(() => {
            if (alertaDiv) alertaDiv.innerHTML = '';
        }, 5000);
    }

    validarSessao();
</script>