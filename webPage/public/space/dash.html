<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bateria | Dashboard</title>
    <link rel="stylesheet" href="../assets/style/dashboards.css">
    <link rel="stylesheet" href="../assets/style/style.css" />
    <script src="../assets/app/sessão.js"></script>
    <script src="../assets/app/alerta.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body onload="validarSessao(), carregarDashboard()">
    <div class="janela">
        <div class="header-left">
            <h1>Bateria Digital</h1>
            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>
            <div class="btn-nav-white">
                <a href="./cards.html">
                    <h3>Minhas Levadas</h3>
                </a>
            </div>
            <div class="btn-nav">
                <h3>Painel das Escolas</h3>
            </div>
            <div class="btn-nav-white">
                <select id="selectAgremiacao" onchange="filtrarDashboard()">
                    <option value="todas">Todas Agremiações</option>
                    <option value="1">Gaviões da Fiel</option>
                    <option value="2">Pérola Negra</option>
                    <option value="3">Vai-Vai</option>
                    <option value="4">União da Ilha</option>
                </select>
            </div>
            <div class="btn-logout" onclick="limparSessao()">
                <h3><a href="./profile.html">Sair</a></h3>
            </div>
        </div>

        <div class="dash">
            <div id="alerta"></div>
            <div class="kpi-container" id="kpiContainer"></div>

            <div class="filtros-container">
                <div class="filtro-item">
                    <label for="filtroAno">Ano:</label>
                    <select id="filtroAno" onchange="filtrarDashboard()">
                        <option value="todos">Todos</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtroProgresso">Progresso:</label>
                    <select id="filtroProgresso" onchange="filtrarDashboard()">
                        <option value="todos">Todos</option>
                        <option value="0-30">0-30%</option>
                        <option value="30-70">30-70%</option>
                        <option value="70-100">70-100%</option>
                    </select>
                </div>
            </div>

            <div class="cards" id="cardsLevadas"></div>
            <div class="kpi-container" id="kpiContainer"></div>
            <div class="graficos-container">
                <h3 class="tituloGraficos">Desempenho das Levadas</h3>
                <div class="graph">
                    <canvas id="graficoDesempenho" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    function carregarKPIs(filtroAgremiacao = 'todas') {
        fetch(`/levadas?agremiacao=${filtroAgremiacao}`)
            .then(response => {
                if (!response.ok) throw new Error('Erro ao carregar KPIs');
                return response.json();
            })
            .then(levadas => {
                const totalLevadas = levadas.length;
                const progressoMedio = totalLevadas > 0 ?
                    levadas.reduce((sum, lev) => sum + (lev.progresso || 0), 0) / totalLevadas : 0;

                const hoje = new Date();
                const atrasadas = levadas.filter(lev => {
                    const prazo = new Date(lev.prazo);
                    return prazo < hoje && lev.progresso < 100;
                }).length;

                document.getElementById('kpiContainer').innerHTML = `
                <div class="kpi-card">
                    <i class="fas fa-music"></i>
                    <div class="kpi-value">${totalLevadas}</div>
                    <div class="kpi-label">Total Levadas</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-chart-line"></i>
                    <div class="kpi-value">${progressoMedio.toFixed(1)}%</div>
                    <div class="kpi-label">Progresso Médio</div>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="kpi-value">${atrasadas}</div>
                    <div class="kpi-label">Atrasadas</div>
                </div>
            `;
            })
            .catch(error => {
                console.error('Erro ao carregar KPIs:', error);
                document.getElementById('kpiContainer').innerHTML = `
                <div class="kpi-card error">
                    <i class="fas fa-exclamation-circle"></i>
                    <div class="kpi-value">-</div>
                    <div class="kpi-label">Erro ao carregar</div>
                </div>
            `;
            });
    }
    function carregarDashboard() {
        const filtroAgremiacao = document.getElementById('selectAgremiacao').value;
        const filtroAno = document.getElementById('filtroAno').value;
        const filtroProgresso = document.getElementById('filtroProgresso').value;

        carregarKPIs(filtroAgremiacao);
        carregarLevadas(filtroAgremiacao, filtroAno, filtroProgresso);
        carregarGraficoDesempenho(filtroAgremiacao);

        setTimeout(carregarDashboard, 30000);
    }

    function carregarGraficoDesempenho(filtroAgremiacao = 'todas') {
        fetch(`/api/desempenho?agremiacao=${filtroAgremiacao}`)
            .then(response => {
                if (!response.ok) throw new Error('Erro na API');
                return response.json();
            })
            .then(dados => {
                criarGrafico(dados);
            })
            .catch(error => {
                console.error('Erro ao carregar gráfico da API:', error);
                const dadosExemplo = {
                    labels: ['Gaviões da Fiel', 'Pérola Negra', 'Vai-Vai', 'União da Ilha'],
                    datasets: [{
                        label: 'Desempenho Médio (%)',
                        data: [75, 68, 82, 79],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                };
                criarGrafico(dadosExemplo);
            });
    }
    function criarGrafico(dados) {
        const ctx = document.getElementById('graficoDesempenho');

        if (!ctx) {
            console.error('Elemento canvas não encontrado');
            return;
        }

        if (window.graficoDesempenho) {
            window.graficoDesempenho.destroy();
        }

        const config = {
            type: 'bar',
            data: {
                labels: dados.labels || [],
                datasets: [{
                    label: dados.datasets?.[0]?.label || 'Desempenho',
                    data: dados.datasets?.[0]?.data || [],
                    backgroundColor: dados.datasets?.[0]?.backgroundColor || 'rgba(54, 162, 235, 0.6)',
                    borderColor: dados.datasets?.[0]?.borderColor || 'rgba(54, 162, 235, 1)',
                    borderWidth: dados.datasets?.[0]?.borderWidth || 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#ffffff'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Desempenho por Agremiação',
                        color: '#e3b062'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: '#ffffff'
                        },
                        title: {
                            display: true,
                            text: 'Progresso (%)',
                            color: '#ffffff' 
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)' 
                        }
                    },
                    x: {
                        ticks: {
                            color: '#ffffff' 
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)' 
                        }
                    }
                }
            }
        };

        window.graficoDesempenho = new Chart(ctx, config);

        setTimeout(() => {
            window.graficoDesempenho.update();
        }, 100);
    }

    function carregarLevadas(filtroAgremiacao, filtroAno, filtroProgresso) {
        fetch(`/levadas?agremiacao=${filtroAgremiacao}&ano=${filtroAno}&progresso=${filtroProgresso}`)
            .then(response => {
                if (!response.ok) throw new Error('Erro na rede');
                return response.json();
            })
            .then(levadas => {
                const levadasFormatadas = levadas.map(levada => ({
                    ...levada,
                    padrao: typeof levada.padrao === 'string' ? JSON.parse(levada.padrao) : levada.padrao || [],
                    agremiacao: levada.agremiacao || 'Sem agremiação',
                    bpm: levada.bpm || 0,
                    instrumento: levada.instrumento || 'Vários'
                }));

                sessionStorage.LEVADAS = JSON.stringify(levadasFormatadas);
                localStorage.setItem('ultimasLevadas', JSON.stringify(levadasFormatadas));
                exibirCardsLevadas(levadasFormatadas);
            })
            .catch(error => {
                console.error('Erro ao carregar:', error);
                const cache = localStorage.getItem('ultimasLevadas');
                if (cache) exibirCardsLevadas(JSON.parse(cache));
            });
    }

    function exibirCardsLevadas(levadas) {
        const container = document.getElementById('cardsLevadas');
        container.innerHTML = '';

        levadas.forEach(levada => {
            container.innerHTML += `
                <div class="card-levada" data-id="${levada.id}">
                    <div class="header-levada">
                        <h2>${levada.nome}</h2>
                        <span class="Ano ${levada.AnoClass}">${levada.AnoText}</span>
                    </div>
                    <div class="detalhes-levada">
                        <div class="info">
                            <p><strong>Agremiação:</strong> ${levada.agremiacao}</p>
                            <p><strong>Prazo:</strong> ${new Date(levada.prazo).toLocaleDateString()}</p>
                            <p><strong>Progresso:</strong> ${levada.progresso}%</p>
                        </div>
                        <div class="progresso">
                            <div class="progresso-bar" style="width: ${levada.progresso}%"></div>
                        </div>
                    </div>
                    <div class="acoes-levada">
                        <button class="btn-acao" onclick="detalharLevada(${levada.id})">
                            <i class="fas fa-info-circle"></i> Detalhes
                        </button>
                        <button class="btn-acao" onclick="editarLevada(${levada.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>
                </div>
            `;
        });
    }

    function filtrarDashboard() {
        const agremiacao = document.getElementById('selectAgremiacao').value;
        const ano = document.getElementById('filtroAno').value;
        const progresso = document.getElementById('filtroProgresso').value;

        carregarLevadas(agremiacao, ano, progresso);
        carregarKPIs(agremiacao);
        carregarGraficoDesempenho(agremiacao);
    }

    function detalharLevada(id) {
        console.log('Detalhar levada:', id);
    }

    function editarLevada(id) {
        console.log('Editar levada:', id);
    }
</script>